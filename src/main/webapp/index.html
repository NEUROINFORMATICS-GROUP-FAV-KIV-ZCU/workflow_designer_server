<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />

        <!-- Third party libraries -->
	<script type="text/javascript" src="blocks_js/jquery.js"></script>
        <script type="text/javascript" src="blocks_js/jquery.json.min.js"></script>
        <script type="text/javascript" src="blocks_js/jquery.mousewheel.min.js"></script>
        <script type="text/javascript" src="blocks_js/jquery.svg.min.js"></script>
        <script type="text/javascript" src="blocks_js/jquery.formserialize.min.js"></script>
        <script type="text/javascript" src="blocks_js/jquery.fancybox.min.js"></script> 
        <link rel="stylesheet" type="text/css" href="blocks_js/fancybox/jquery.fancybox.css" />

        <!-- block_definitions.js -->
	<script type="text/javascript" src="blocks_js/blocks.js"></script> 
        <link rel="stylesheet" type="text/css" href="blocks_js/blocks.css" />

        <!-- Demo script -->
        <script type="text/javascript" src="main.js"></script>
        <link rel="stylesheet" type="text/css" href="css/style.css" />

        <link rel="Shortcut Icon" href="favicon.ico" type="image/x-icon" /> 
        <title>INCF Signal Workflow Designer</title>
    </head>
    <body>
        
        <div id="blocks"></div>
		<span>
            <!--<button class="setLabel">Set the edges label</button>-->
            <!--<button class="setInfos">Set the block infos</button>-->
            <!--<button class="setDescriptions">Set the block descriptions</button>-->
            <!--<button class="resize">Resize the div</button>-->
            <!--<button class="hideIcons">Hide icons</button>-->
            <button class="loadBlocks">Load Block Configuration</button>
            <button class="open">Open Workflow</button>
            <button class="save">Save Workflow</button>
            <button class="execute">Execute Workflow</button>
		</span>

        <form method="POST" enctype="multipart/form-data" id="fileUploadForm">
            Package:
            <input type="text" name="package" id="package" value=""/>
            <input type="file" name="file" id="file" />
            <input type="submit"></form>
        </form>




        <script>
            $(document).ready(function () {

                $("#fileUploadForm").submit(function (event) {

                    event.preventDefault();
                    // Get form
                    var form = $('#fileUploadForm')[0];

                    // Create an FormData object
                    var data = new FormData(form);

                    // If you want to add an extra field for the FormData
                    //data.append("CustomField", "This is some extra data, testing");

                    $.ajax({
                        type: "POST",
                        enctype: 'multipart/form-data',
                        url: "rest/workflow/upload",
                        data: data,
                        processData: false,
                        contentType: false,
                        cache: false,
                        timeout: 600000,
                        success: function (data) {

                            blocks.register(JSON.parse(data));

                        },
                        error: function (e) {

                            alert("Error!"+e.responseText);

                        }
                    });

                });

                $(".execute").click(function(event){

                    // Create an FormData object
                    var data = new FormData();

                    // If you want to add an extra field for the FormData
                    data.append("workflow", JSON.stringify(blocks.export()));

                    $.ajax({
                        type: "POST",
                        enctype: 'multipart/form-data',
                        url: "rest/workflow/execute",
                        data: data,
                        processData: false,
                        contentType: false,
                        cache: false,
                        timeout: 600000,
                        success: function (data) {
                            data = JSON.parse(data);
                            console.log(data);
                            for (var k in blocks.blocks) {
                                var block = blocks.blocks[k];

                                for(var x in data){
                                    if(data[x].id===block.id){
                                        if(data[x].output){
                                            block.setInfos('Previous Output:'+data[x].output);
                                        }
                                    }
                                }

                            }

                            // blocks.load(data);

                        },
                        error: function (e) {

                            alert("Error!"+e.responseText);

                        }
                    });
                });

            });
        </script>
    </body>
</html>
